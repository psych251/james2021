```{r}
library(tidyverse)
library(lme4)
library(ggpirate)
```

```{r}
recog <- read.csv("storyAdults_recognition.csv") %>%
  filter(valid == 1)
```

```{r}
vocab <- read.csv("storyAdults_background.csv") %>%
  select(ID, vocabRaw)

recog <- merge(recog, vocab, by = "ID")
```
Descriptive statistics
```{r}
# Relevel neighbour factor so that it prints in a logical order
recog$neighb <- fct_relevel(recog$neighb, c("none", "one", "many"))

# Summarise per condition
recog %>%
  group_by(session) %>%
  summarise(mean = mean(acc), sd = sd(acc))
```
```{r}
recog %>%
  group_by(neighb) %>%
  summarise(mean = mean(acc), sd = sd(acc))
```

```{r}
recog %>%
  group_by(session, neighb) %>%
  summarise(mean = mean(acc), sd = sd(acc))
```

```{r}
pptMeans <- recog %>%
  select(ID, session, acc) %>%
  filter(session == 1) %>%
  group_by(ID) %>%
  summarise(mean = mean(acc, na.rm = TRUE))
```

```{r}
t.test(pptMeans$mean, mu=.25, alternative = "greater")

```
Preparation for analysis

Word Neighbors
```{r}
neighb.contrasts <- cbind(c(-2, 1, 1), c(0,-1,1))
contrasts(recog$neighb) <- neighb.contrasts
contrasts(recog$neighb)
```
Test Session
```{r}
recog$session <- as.factor(recog$session)
session.contrasts <- cbind(c(-2, 1, 1), c(0,-1,1))
contrasts(recog$session) <- session.contrasts
contrasts(recog$session)
```
Vocabulary ability
```{r}
recog$vocabS <- scale(recog$vocabRaw, center = TRUE, scale = TRUE) 
```

Model building
Pruning of fixed effects
```{r}
fix.full <- glmer(acc ~ session*neighb*vocabS + (1|ID) + (1|item), 
                  data = recog, family = binomial, control = glmerControl(optimizer = "bobyqa"))
#summary(fix.full) 
```

```{r}
fix.pars <- glmer(acc ~ session*neighb + session*vocabS + neighb*vocabS + (1|ID) + (1|item), 
                  data = recog, family = binomial, control = glmerControl(optimizer = "bobyqa"))
anova(fix.pars, fix.full)
```
Build random effects structure
```{r}
# Model without random effects for participants
mod.items <- glmer(acc ~ session*neighb + session*vocabS + neighb*vocabS + (1|item), 
                  data = recog, family = binomial, control = glmerControl(optimizer = "bobyqa"))
anova(mod.items, fix.pars) 

```
```{r}

# Model without random effects for items
mod.ppts <- glmer(acc ~ session*neighb + session*vocabS + neighb*vocabS + (1|ID), 
                  data = recog, family = binomial, control = glmerControl(optimizer = "bobyqa"))
anova(mod.ppts, fix.pars)
```
By-participant random slopes
```{r}
# Model with by-participant slopes for the effect of test session
mod1 <- glmer(acc ~ session*neighb + session*vocabS + neighb*vocabS + (1+session|ID) + (1|item), 
                  data = recog, family = binomial, control = glmerControl(optimizer = "bobyqa"))

```
```{r}
anova(fix.pars, mod1)
```

```{r}
# Model with by-participant slopes for the effect of neighbour condition
mod2 <- glmer(acc ~ session*neighb + session*vocabS + neighb*vocabS + (1+neighb|ID) + (1|item), 
                  data = recog, family = binomial, control = glmerControl(optimizer = "bobyqa"))
anova(fix.pars, mod2)
```
Only random slopes for neighbour condition improved model fit. Check that test session does not contribute beyond this.

```{r}
# Model with by-participant slopes for the effects of neighbour condition and test session
mod2a <- glmer(acc ~ session*neighb + session*vocabS + neighb*vocabS + (1+neighb+session|ID) + (1|item), 
                  data = recog, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
anova(mod2, mod2a)
```
By-item random slopes
```{r}
# Model with by-item slopes for the effect of test session
mod3 <- glmer(acc ~ session*neighb + session*vocabS + neighb*vocabS + (1+neighb|ID) + (1+session|item), 
                  data = recog, family = binomial, control = glmerControl(optimizer = "bobyqa"))
```

```{r}
anova(mod2, mod3)
```
```{r}
# Model with by-item slopes for the effect of vocabulary
mod4 <- glmer(acc ~ session*neighb + session*vocabS + neighb*vocabS + (1+neighb|ID) + (1+vocabS|item), 
                  data = recog, family = binomial, control = glmerControl(optimizer = "bobyqa"))
anova(mod2, mod4)
```

Final model
```{r}
summary(mod2)
```
Plot Graphs
Create participant means
```{r}
cond.means <- recog %>%
  group_by(ID, session, neighb) %>%
  summarise(meanAcc = mean(acc))
```

Recognition for words of different word neighbour conditions at each time point
```{r}
recogGraph <- ggplot(data = cond.means, aes(x=session, y=meanAcc)) +
  theme_bw() + 
  geom_pirate(aes(colour=neighb, fill = neighb), show.legend = TRUE, 
              points_params = list(alpha = 1, size = 3), 
              lines_params = list(size=0.9)) + 
  scale_color_discrete(name = "Word-form neighbours:") +
  scale_fill_discrete(name = "Word-form neighbours:") + 
  scale_x_discrete(name = "Test session", breaks = c(1, 2, 3), labels = c("Same day", "Next day", "Week later")) + 
  scale_y_continuous(name = "Percent correct", labels = scales::percent) + 
  theme(legend.position = "top",
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        legend.box.background = element_rect(colour = "black"),
        strip.text = element_text(size = 20),
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 14)) + 
  geom_hline(yintercept = 0.25, linetype = "dashed") #line to mark chance-level performance
```
```{r}
print(recogGraph)
```
R Version information
```{r}
sessionInfo()

```

